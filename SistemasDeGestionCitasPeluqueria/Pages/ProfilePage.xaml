<?xml version="1.0" encoding="utf-8"?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:pageModels="clr-namespace:SistemasDeGestionCitasPeluqueria.PageModels"
             xmlns:models="clr-namespace:SistemasDeGestionCitasPeluqueria.Models"
             xmlns:conv="clr-namespace:SistemasDeGestionCitasPeluqueria.Converters"
             x:Class="SistemasDeGestionCitasPeluqueria.Pages.ProfilePage"
             x:DataType="pageModels:ProfilePageModel"
             Title="Mi Perfil"
             BackgroundColor="{StaticResource SurfaceAlt}"
             Padding="12">

    <ContentPage.Resources>
        <ResourceDictionary>
            <conv:BookingIsoToDisplayConverter x:Key="BookingIsoToDisplayConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <ScrollView>
        <Grid HorizontalOptions="FillAndExpand" VerticalOptions="FillAndExpand">
            <VerticalStackLayout Spacing="18" Padding="0,6,0,40" HorizontalOptions="FillAndExpand">

                <!-- Header -->
                <VerticalStackLayout Spacing="4">
                    <Label Text="Mi Perfil" Style="{StaticResource TitleLargeStyle}" />
                    <Label Text="Gestiona tu información personal y citas" Style="{StaticResource MutedTextStyle}" />
                </VerticalStackLayout>

                <!-- Próximas Citas (mantener por ahora, opcional a reemplazar) -->
                <Frame BackgroundColor="{StaticResource ServiceIconBgLight}"
                       CornerRadius="10"
                       Padding="18"
                       HasShadow="False"
                       BorderColor="{StaticResource CardBorder}"
                       HorizontalOptions="FillAndExpand">
                    <!-- (contenido mantenido sin cambios para la zona de próximas citas) -->
                    <Grid ColumnDefinitions="2*,1*" RowDefinitions="Auto" ColumnSpacing="16">
                        <!-- ... contenido existente (igual que antes) ... -->
                        <VerticalStackLayout Grid.Column="0" Spacing="12" HorizontalOptions="FillAndExpand">
                            <HorizontalStackLayout Spacing="12" VerticalOptions="Center">
                                <Frame Style="{StaticResource InfoIconFrameStyle}"
                                       Background="{StaticResource AccentBrush}"
                                       WidthRequest="40"
                                       HeightRequest="40"
                                       CornerRadius="8"
                                       Padding="8"
                                       HasShadow="False">
                                    <Label FontFamily="{StaticResource SymbolThemeFontFamily}"
                                           Text="{StaticResource IconGlyph.Calendar}"
                                           TextColor="{StaticResource White}"
                                           HorizontalTextAlignment="Center"
                                           VerticalTextAlignment="Center"
                                           FontSize="16"/>
                                </Frame>

                                <VerticalStackLayout>
                                    <Label Text="Próximas Citas" Style="{StaticResource InfoCardTitleStyle}" />
                                    <Label Text="Tus próximas reservas programadas" Style="{StaticResource InfoCardSubTextStyle}" />
                                </VerticalStackLayout>
                            </HorizontalStackLayout>

                            <Frame Style="{StaticResource CardFrameStyle}"
                                   CornerRadius="8"
                                   Padding="12"
                                   HasShadow="False"
                                   HorizontalOptions="FillAndExpand">
                                <!-- Ejemplo estático por ahora (puedes sustituir luego) -->
                                <Grid ColumnDefinitions="Auto,*,Auto" RowDefinitions="Auto,Auto,Auto" ColumnSpacing="10" RowSpacing="8">
                                    <Label Grid.Row="0" Grid.Column="0" FontFamily="{StaticResource SymbolThemeFontFamily}"
                                           Text="{StaticResource IconGlyph.History}" FontSize="18" TextColor="{StaticResource Gray600}" VerticalOptions="Start" />

                                    <VerticalStackLayout Grid.Row="0" Grid.Column="1" Spacing="2">
                                        <Label Text="Coloración" FontAttributes="Bold" FontSize="14" TextColor="{StaticResource TextPrimary}" />
                                        <Label Text="con Ana R." FontSize="12" TextColor="{StaticResource TextSecondary}" />
                                    </VerticalStackLayout>

                                    <Frame Grid.Row="0" Grid.Column="2" BackgroundColor="{StaticResource Accent}" Padding="8,4" CornerRadius="6" HasShadow="False" VerticalOptions="Start" HorizontalOptions="End">
                                        <Label Text="Confirmada" FontSize="12" TextColor="{StaticResource White}" />
                                    </Frame>

                                    <HorizontalStackLayout Grid.Row="1" Grid.Column="1" Grid.ColumnSpan="2" Spacing="12" VerticalOptions="Center">
                                        <Label FontFamily="{StaticResource SymbolThemeFontFamily}" Text="{StaticResource IconGlyph.Schedule}" TextColor="{StaticResource Gray600}" />
                                        <Label Text="28 Oct, 2025" FontSize="12" TextColor="{StaticResource Gray600}" />
                                        <Label Text="•" TextColor="{StaticResource Gray600}" />
                                        <Label Text="12:00" FontSize="12" TextColor="{StaticResource Gray600}" />
                                    </HorizontalStackLayout>

                                    <FlexLayout Grid.Row="2" Grid.Column="1" Grid.ColumnSpan="2"
                                                Direction="Row" Wrap="Wrap"
                                                JustifyContent="End" AlignItems="Center" AlignContent="End" Padding="0">
                                        <Button Text="Cancelar"
                                                Style="{StaticResource SecondaryButtonStyle}"
                                                WidthRequest="100"
                                                Margin="0,0,12,12"/>
                                        <Button Text="Ver detalles"
                                                Style="{StaticResource PrimaryButtonSmall}"
                                                WidthRequest="120"
                                                Margin="0,0,12,12"/>
                                    </FlexLayout>
                                </Grid>
                            </Frame>
                        </VerticalStackLayout>

                        <Frame Grid.Column="1"
                               BackgroundColor="{StaticResource ServiceIconBgLight}"
                               CornerRadius="8"
                               Padding="24"
                               HasShadow="False"
                               BorderColor="{StaticResource CardBorder}"
                               HorizontalOptions="FillAndExpand"
                               VerticalOptions="FillAndExpand">
                            <VerticalStackLayout HorizontalOptions="Center" VerticalOptions="Center" Spacing="8">
                                <Label FontFamily="{StaticResource SymbolThemeFontFamily}" Text="{StaticResource IconGlyph.Calendar}" FontSize="28" TextColor="{StaticResource Gray600}" HorizontalOptions="Center"/>
                                <Label Text="No hay más citas programadas" FontSize="13" TextColor="{StaticResource Gray600}" HorizontalOptions="Center"/>
                                <Button Text="Reservar nueva cita" BackgroundColor="Transparent" TextColor="{StaticResource Accent}" CornerRadius="6" />
                            </VerticalStackLayout>
                        </Frame>
                    </Grid>
                </Frame>

                <!-- Grid principal (información + sidebar) -->
                <Grid ColumnDefinitions="2*,1*" ColumnSpacing="12" RowSpacing="12" HorizontalOptions="FillAndExpand">

                    <VerticalStackLayout Grid.Column="0" Spacing="12" HorizontalOptions="FillAndExpand">
                        <Frame Style="{StaticResource CardFrameStyle}" Padding="16" HasShadow="False" HorizontalOptions="FillAndExpand">
                            <Grid ColumnDefinitions="Auto, *" RowDefinitions="Auto, Auto" ColumnSpacing="16" RowSpacing="8">
                                <VerticalStackLayout Grid.Row="0" Grid.RowSpan="2" Grid.Column="0" Spacing="8" HorizontalOptions="Start" Margin="0,0,8,0">
                                    <!-- Avatar: muestra la imagen si hay PhotoUrl; si no, el icono -->
                                    <Frame WidthRequest="64"
                                           HeightRequest="64"
                                           CornerRadius="32"
                                           Padding="0"
                                           HasShadow="False"
                                           BorderColor="{StaticResource CardBorder}"
                                           BackgroundColor="{StaticResource Surface}"
                                           HorizontalOptions="Start"
                                           IsClippedToBounds="True">
                                        <Grid>
                                            <!-- Fallback: icono -->
                                            <Label FontFamily="{StaticResource SymbolThemeFontFamily}"
                                                   Text="{StaticResource IconGlyph.Profile}"
                                                   FontSize="28"
                                                   TextColor="{StaticResource Gray600}"
                                                   HorizontalTextAlignment="Center"
                                                   VerticalTextAlignment="Center"
                                                   VerticalOptions="Center"
                                                   HorizontalOptions="Center"/>
                                            <!-- Imagen real (si PhotoUrl es válida se verá sobre el icono) -->
                                            <Image
                                                Aspect="AspectFill"
                                                HorizontalOptions="FillAndExpand"
                                                VerticalOptions="FillAndExpand"
                                                Source="{Binding PhotoUrl, Converter={StaticResource ImageSourceFromStringConverter}}"/>
                                        </Grid>
                                    </Frame>

                                    <Label Text="{Binding DisplayName}" FontAttributes="Bold" TextColor="{StaticResource TextPrimary}" HorizontalOptions="Start"/>
                                    <Label Text="{Binding ClientSinceText}" FontSize="12" TextColor="{StaticResource TextSecondary}" HorizontalOptions="Start"/>
                                    <Button Text="Cambiar foto"
                                            Style="{StaticResource SecondaryButtonStyle}"
                                            HorizontalOptions="Start"
                                            Command="{Binding ChangePhotoCommand}" />
                                </VerticalStackLayout>

                                <Grid Grid.Row="0" Grid.Column="1" ColumnSpacing="12" RowSpacing="8" HorizontalOptions="FillAndExpand">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="*" />
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                    </Grid.RowDefinitions>

                                    <Label Grid.Row="0" Grid.Column="0" Text="Nombre completo" FontSize="12" TextColor="{StaticResource Gray600}" Margin="0,0,0,4"/>
                                    <Entry Grid.Row="1" Grid.Column="0" Text="{Binding Name}" BackgroundColor="{StaticResource SurfaceAlt}" TextColor="{StaticResource Gray950}" PlaceholderColor="{StaticResource Gray600}" HorizontalOptions="FillAndExpand" HeightRequest="42" />

                                    <Label Grid.Row="0" Grid.Column="1" Text="Email" FontSize="12" TextColor="{StaticResource Gray600}" Margin="0,0,0,4"/>
                                    <Entry Grid.Row="1" Grid.Column="1" Text="{Binding Email}" Keyboard="Email" BackgroundColor="{StaticResource SurfaceAlt}" TextColor="{StaticResource Gray950}" PlaceholderColor="{StaticResource Gray600}" HorizontalOptions="FillAndExpand" HeightRequest="42" />

                                    <Label Grid.Row="2" Grid.Column="0" Text="Teléfono" FontSize="12" TextColor="{StaticResource Gray600}" Margin="0,8,0,4"/>
                                    <Entry Grid.Row="3" Grid.Column="0" Text="{Binding Phone}" Keyboard="Telephone" BackgroundColor="{StaticResource SurfaceAlt}" TextColor="{StaticResource Gray950}" PlaceholderColor="{StaticResource Gray600}" HorizontalOptions="FillAndExpand" HeightRequest="42" />

                                    <Label Grid.Row="2" Grid.Column="1" Text="Fecha de nacimiento" FontSize="12" TextColor="{StaticResource Gray600}" Margin="0,8,0,4"/>
                                    <!-- DatePicker nativo -->
                                    <DatePicker Grid.Row="3" Grid.Column="1"
                                                Date="{Binding BirthDate, Mode=TwoWay}"
                                                Format="dd/MM/yyyy"
                                                MinimumDate="{Binding MinBirthDate}"
                                                MaximumDate="{Binding MaxBirthDate}"
                                                BackgroundColor="{StaticResource SurfaceAlt}"
                                                TextColor="{StaticResource Gray950}"
                                                HorizontalOptions="FillAndExpand"
                                                HeightRequest="42" />
                                </Grid>

                                <FlexLayout Grid.Row="1" Grid.Column="1"
                                            Direction="Row"
                                            Wrap="Wrap"
                                            JustifyContent="End"
                                            AlignItems="Center"
                                            AlignContent="End"
                                            Margin="0,6,0,0">
                                    <Button Text="Cancelar" Style="{StaticResource SecondaryButtonStyle}" WidthRequest="100" Margin="0,0,8,8"
                                            Command="{Binding LoadCommand}" />
                                    <Button Text="Guardar cambios" Style="{StaticResource PrimarySuccessButton}" WidthRequest="140" Margin="0,0,8,8"
                                            Command="{Binding SaveCommand}" />
                                </FlexLayout>
                            </Grid>
                        </Frame>

                        <!-- Historial dinámico: ahora enlazado a Bookings -->
                        <Frame BackgroundColor="{StaticResource CardBackground}" CornerRadius="8" BorderColor="{StaticResource CardBorder}" Padding="16" HasShadow="False" HorizontalOptions="FillAndExpand">
                            <VerticalStackLayout Spacing="12">
                                <Label Text="Historial de Citas" FontAttributes="Bold" TextColor="{StaticResource TextPrimary}" />

                                <CollectionView ItemsSource="{Binding Bookings}" SelectionMode="None" EmptyView="No tienes citas registradas.">
                                    <CollectionView.ItemTemplate>
                                        <DataTemplate x:DataType="models:BookingDto">
                                            <Frame CornerRadius="6" BorderColor="{StaticResource CardBorder}" Padding="12" BackgroundColor="{StaticResource Surface}" HasShadow="False" HorizontalOptions="FillAndExpand">
                                                <Grid ColumnDefinitions="Auto,*,Auto" RowDefinitions="Auto,Auto" ColumnSpacing="12">
                                                    <Label Grid.Row="0" Grid.RowSpan="2" Grid.Column="0" FontFamily="{StaticResource SymbolThemeFontFamily}" Text="{StaticResource IconGlyph.History}" FontSize="16" TextColor="{StaticResource Gray600}" VerticalOptions="Center" />

                                                    <!-- Mostrar nombre del servicio (fall back incluido en ViewModel/DTO) -->
                                                    <Label Grid.Row="0" Grid.Column="1" Text="{Binding DisplayService}" FontAttributes="Bold" TextColor="{StaticResource TextPrimary}" HorizontalOptions="Start" />

                                                    <!-- Estado -->
                                                    <Frame Grid.Row="0" Grid.Column="2" BackgroundColor="{StaticResource Secondary}" Padding="6,4" CornerRadius="6" HasShadow="False" VerticalOptions="Start" HorizontalOptions="End">
                                                        <Label Text="{Binding Status}" FontSize="12" TextColor="{StaticResource Gray950}" />
                                                    </Frame>

                                                    <!-- Línea secundaria: cliente • barbero • fecha • hora -->
                                                    <HorizontalStackLayout Grid.Row="1" Grid.Column="1" Grid.ColumnSpan="2" Spacing="8" VerticalOptions="Center">
                                                        <Label Text="{Binding CustomerName}" FontSize="12" TextColor="{StaticResource Gray600}" />
                                                        <Label Text="•" TextColor="{StaticResource Gray600}" />
                                                        <Label Text="{Binding DisplayBarber}" FontSize="12" TextColor="{StaticResource Gray600}" />
                                                        <Label Text="•" TextColor="{StaticResource Gray600}" />
                                                        <Label Text="{Binding Start, Converter={StaticResource BookingIsoToDisplayConverter}, ConverterParameter=date}" FontSize="12" TextColor="{StaticResource Gray600}" />
                                                        <Label Text="•" TextColor="{StaticResource Gray600}" />
                                                        <Label Text="{Binding Start, Converter={StaticResource BookingIsoToDisplayConverter}, ConverterParameter=time}" FontSize="12" TextColor="{StaticResource Gray600}" />
                                                    </HorizontalStackLayout>
                                                </Grid>
                                            </Frame>
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                </CollectionView>
                            </VerticalStackLayout>
                        </Frame>
                    </VerticalStackLayout>

                    <VerticalStackLayout Grid.Column="1" Spacing="12" HorizontalOptions="FillAndExpand">
                        <Frame Style="{StaticResource CardFrameStyle}" Padding="12" HasShadow="False" HorizontalOptions="FillAndExpand">
                            <VerticalStackLayout Spacing="10">
                                <Label Text="Estadísticas" FontAttributes="Bold" TextColor="{StaticResource TextPrimary}" />
                                <Frame BackgroundColor="{StaticResource Surface}" CornerRadius="6" Padding="12" BorderColor="{StaticResource CardBorder}" HasShadow="False" HorizontalOptions="FillAndExpand">
                                    <VerticalStackLayout Spacing="4">
                                        <Label Text="Total de citas" FontSize="12" TextColor="{StaticResource Gray600}" />
                                        <Label Text="24" FontAttributes="Bold" FontSize="18" TextColor="{StaticResource Gray950}" />
                                    </VerticalStackLayout>
                                </Frame>
                                <Frame BackgroundColor="{StaticResource Surface}" CornerRadius="6" Padding="12" BorderColor="{StaticResource CardBorder}" HasShadow="False" HorizontalOptions="FillAndExpand">
                                    <VerticalStackLayout Spacing="4">
                                        <Label Text="Próximas citas" FontSize="12" TextColor="{StaticResource Gray600}" />
                                        <Label Text="1" FontAttributes="Bold" FontSize="18" TextColor="{StaticResource Gray950}" />
                                    </VerticalStackLayout>
                                </Frame>
                                <Frame BackgroundColor="{StaticResource Surface}" CornerRadius="6" Padding="12" BorderColor="{StaticResource CardBorder}" HasShadow="False" HorizontalOptions="FillAndExpand">
                                    <VerticalStackLayout Spacing="4">
                                        <Label Text="Servicio favorito" FontSize="12" TextColor="{StaticResource Gray600}" />
                                        <Label Text="Corte de pelo" FontSize="14" TextColor="{StaticResource Gray950}" />
                                    </VerticalStackLayout>
                                </Frame>
                                <Frame BackgroundColor="{StaticResource Surface}" CornerRadius="6" Padding="12" BorderColor="{StaticResource CardBorder}" HasShadow="False" HorizontalOptions="FillAndExpand">
                                    <VerticalStackLayout Spacing="4">
                                        <Label Text="Barbero favorito" FontSize="12" TextColor="{StaticResource Gray600}" />
                                        <Label Text="Carlos M." FontSize="14" TextColor="{StaticResource Gray950}" />
                                    </VerticalStackLayout>
                                </Frame>
                            </VerticalStackLayout>
                        </Frame>

                        <Frame Style="{StaticResource CardFrameStyle}" Padding="12" HasShadow="False" HorizontalOptions="FillAndExpand">
                            <VerticalStackLayout Spacing="8">
                                <Label Text="Contacto" FontAttributes="Bold" TextColor="{StaticResource TextPrimary}" />
                                <HorizontalStackLayout Spacing="8">
                                    <Label FontFamily="{StaticResource SymbolThemeFontFamily}" Text="{StaticResource IconGlyph.Phone}" TextColor="{StaticResource Gray600}" />
                                    <Label Text="{Binding Email}" FontSize="13" TextColor="{StaticResource TextSecondary}" />
                                </HorizontalStackLayout>
                                <HorizontalStackLayout Spacing="8">
                                    <Label FontFamily="{StaticResource SymbolThemeFontFamily}" Text="{StaticResource IconGlyph.Phone}" TextColor="{StaticResource Gray600}" />
                                    <Label Text="{Binding Phone}" FontSize="13" TextColor="{StaticResource TextSecondary}" />
                                </HorizontalStackLayout>
                            </VerticalStackLayout>
                        </Frame>

                        <!-- Botón Cerrar sesión -->
                        <Button x:Name="LogoutButton"
                                Text="Cerrar sesión"
                                Style="{StaticResource OutlineButtonStyle}"
                                BorderColor="{DynamicResource ErrorAlertText}"
                                TextColor="{DynamicResource ErrorAlertText}"
                                BackgroundColor="Transparent"
                                HorizontalOptions="FillAndExpand"
                                Margin="0,6,0,0"
                                Command="{Binding LogoutCommand}" />
                    </VerticalStackLayout>

                </Grid>
            </VerticalStackLayout>
        </Grid>
    </ScrollView>
</ContentPage>