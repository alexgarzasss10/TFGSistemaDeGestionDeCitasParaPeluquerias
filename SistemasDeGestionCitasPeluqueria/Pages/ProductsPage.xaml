<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:SistemasDeGestionCitasPeluqueria.PageModels"
             xmlns:models="clr-namespace:SistemasDeGestionCitasPeluqueria.Models"
             xmlns:conv="clr-namespace:SistemasDeGestionCitasPeluqueria.Converters"
             x:Class="SistemasDeGestionCitasPeluqueria.Pages.ProductsPage"
             x:DataType="vm:ProductsPageModel"
             x:Name="Root"
             Title="Productos"
             BackgroundColor="{DynamicResource Surface}">

    <ContentPage.Resources>
        <ResourceDictionary>
            <conv:ImageSourceFromStringConverter x:Key="ImageSourceFromStringConverter" />

            <!-- Nuevo estilo para insignia de marca (más discreto que ChipStyle) -->
            <Style x:Key="BrandBadgeStyle" TargetType="Border">
                <Setter Property="BackgroundColor" Value="{DynamicResource SurfaceVariant}" />
                <Setter Property="Stroke" Value="{DynamicResource SurfaceVariant}" />
                <Setter Property="Padding" Value="6,2" />
                <Setter Property="Shadow" Value="{x:Null}" />
                <Setter Property="StrokeShape">
                    <RoundRectangle CornerRadius="8" />
                </Setter>
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <CollectionView ItemsSource="{Binding Products}"
                    SelectionMode="None"
                    ItemSizingStrategy="MeasureFirstItem">
        <CollectionView.Header>
            <VerticalStackLayout Padding="16" Spacing="16">
                <VerticalStackLayout Spacing="4">
                    <Label Text="Productos" Style="{StaticResource TitleLargeStyle}" />
                    <Label Text="Productos profesionales disponibles en tienda"
                           Style="{StaticResource BodyTextStyle}" />
                </VerticalStackLayout>

                <ActivityIndicator IsVisible="{Binding IsBusy}" IsRunning="{Binding IsBusy}" />

                <CollectionView ItemsSource="{Binding Categories}"
                                SelectionMode="Single"
                                SelectedItem="{Binding SelectedCategory, Mode=TwoWay}">
                    <CollectionView.ItemsLayout>
                        <LinearItemsLayout Orientation="Horizontal" ItemSpacing="8"/>
                    </CollectionView.ItemsLayout>
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="x:String">
                            <Border Style="{StaticResource CategoryChipStyle}">
                                <Label Text="{Binding .}" TextColor="{DynamicResource TextPrimary}" />
                            </Border>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </VerticalStackLayout>
        </CollectionView.Header>

        <CollectionView.EmptyView>
            <Label Text="No hay productos disponibles." Style="{StaticResource MutedTextStyle}" />
        </CollectionView.EmptyView>

        <CollectionView.ItemsLayout>
            <GridItemsLayout Orientation="Vertical"
                             Span="{OnIdiom Phone=1, Tablet=2, Desktop=3}" />
        </CollectionView.ItemsLayout>

        <CollectionView.ItemTemplate>
            <DataTemplate x:DataType="models:InventoryItem">
                <Frame Style="{StaticResource CardFrameStyle}" Margin="6" HasShadow="True">
                    <!-- Ajustamos la rejilla: quitamos la fila exclusiva para la marca -->
                    <Grid RowDefinitions="Auto,Auto,Auto"
                          ColumnDefinitions="*,Auto">

                        <!-- Imagen con overlay de marca -->
                        <Frame Grid.Row="0" Grid.ColumnSpan="2"
                               Style="{StaticResource ImageCardStyle}"
                               Padding="0"
                               IsClippedToBounds="True"
                               BackgroundColor="{DynamicResource CardBackground}">
                            <Grid>
                                <Image Aspect="AspectFit"
                                       HeightRequest="220"
                                       HorizontalOptions="Fill"
                                       VerticalOptions="Center"
                                       BackgroundColor="{DynamicResource CardBackground}"
                                       Source="{Binding ImageUrl,
                                                        Converter={StaticResource ImageSourceFromStringConverter},
                                                        TargetNullValue='https://picsum.photos/800/400?blur=2',
                                                        FallbackValue='https://picsum.photos/800/400?blur=2'}" />

                                <!-- Badge pequeña para la marca -->
                                <Border Style="{StaticResource BrandBadgeStyle}"
                                        HorizontalOptions="Start"
                                        VerticalOptions="Start"
                                        Margin="8">
                                    <Label Text="{Binding Brand}"
                                           FontSize="12"
                                           TextColor="{DynamicResource TextPrimary}" />
                                </Border>
                            </Grid>
                        </Frame>

                        <!-- Precio arriba a la derecha (misma fila que antes) -->
                        <Label Grid.Row="1" Grid.Column="1"
                               Text="{Binding Price, StringFormat='{}{0:C}'}"
                               TextColor="{DynamicResource Accent}"
                               FontAttributes="Bold"
                               HorizontalOptions="End"
                               VerticalOptions="Center"
                               Margin="8,12,8,0"/>

                        <!-- Nombre -->
                        <Label Grid.Row="1" Grid.Column="0"
                               Text="{Binding Name}"
                               Style="{StaticResource SectionTitleStyle}"
                               Margin="12,12,0,0" />

                        <!-- Descripción + Stock -->
                        <VerticalStackLayout Grid.Row="2" Grid.ColumnSpan="2" Spacing="6" Margin="12,4,12,8">
                            <Label Text="{Binding Description}"
                                   Style="{StaticResource BodyTextStyle}" />
                            <Label Text="{Binding Stock, StringFormat='Stock: {0} unidades'}"
                                   Style="{StaticResource MutedTextStyle}" />
                        </VerticalStackLayout>

                    </Grid>
                </Frame>
            </DataTemplate>
        </CollectionView.ItemTemplate>
    </CollectionView>
</ContentPage>