<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:SistemasDeGestionCitasPeluqueria.PageModels"
             xmlns:conv="clr-namespace:SistemasDeGestionCitasPeluqueria.Converters"
             xmlns:models="clr-namespace:SistemasDeGestionCitasPeluqueria.Models"
             x:Class="SistemasDeGestionCitasPeluqueria.Pages.ReviewsPage"
             x:DataType="vm:ReviewsPageModel"
             x:Name="Root"
             Title="Reseñas"
             BackgroundColor="{DynamicResource Surface}">

    <ContentPage.Resources>
        <ResourceDictionary>
            <conv:RatingToStarsConverter x:Key="StarsConverter" />
            <conv:TimeAgoConverter x:Key="TimeAgoConverter" />
            <conv:RatingToProgressConverter x:Key="ProgressConv" />
            <conv:NameInitialConverter x:Key="NameInitialConverter" />
            <conv:NullToBoolConverter x:Key="NullToBool" />
            <conv:NullToInverseBoolConverter x:Key="NullToInverseBool" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <ScrollView>
        <VerticalStackLayout Padding="16" Spacing="16">
            <Grid ColumnDefinitions="*,Auto" VerticalOptions="Center">
                <VerticalStackLayout Spacing="2">
                    <Label Text="Reseñas" Style="{StaticResource TitleLargeStyle}" />
                    <Label Text="Lo que dicen nuestros clientes" Style="{StaticResource BodyTextStyle}" />
                </VerticalStackLayout>
                <Button Grid.Column="1"
                        Text="＋ Añadir reseña"
                        Style="{StaticResource PrimaryButtonStyle}"
                        Clicked="OnAddReviewClicked" />
            </Grid>

            <ActivityIndicator IsRunning="{Binding IsBusy}" IsVisible="{Binding IsBusy}" />

            <!-- Tarjeta de estadísticas -->
            <Frame Style="{StaticResource CardFrameStyle}" HasShadow="True">
                <Grid ColumnDefinitions="120,*" ColumnSpacing="16">
                    <!-- Izquierda: promedio -->
                    <VerticalStackLayout Spacing="4" VerticalOptions="Center">
                        <Label Text="{Binding AverageRating, StringFormat='{}{0:F1}'}"
                               FontSize="44" FontAttributes="Bold"
                               TextColor="{DynamicResource TextPrimary}" />
                        <Label Text="{Binding AverageRating, Converter={StaticResource StarsConverter}}"
                               FontSize="20" TextColor="{DynamicResource Accent}" />
                        <Label Text="{Binding TotalReviews, StringFormat='{}{0} reseñas'}"
                               Style="{StaticResource MutedTextStyle}" />
                    </VerticalStackLayout>

                    <!-- Derecha: distribución -->
                    <VerticalStackLayout Grid.Column="1" Spacing="8"
                                          BindableLayout.ItemsSource="{Binding RatingDistribution}">
                        <BindableLayout.ItemTemplate>
                            <DataTemplate x:DataType="vm:RatingDistributionItem">
                                <Grid ColumnDefinitions="20,20,*,30" RowDefinitions="Auto" ColumnSpacing="4">
                                    <Label Grid.Column="0" Text="{Binding Rating}" VerticalOptions="Center" />
                                    <Label Grid.Column="1" Text="★"
                                           TextColor="{DynamicResource Accent}"
                                           VerticalOptions="Center" />
                                    <ProgressBar Grid.Column="2"
                                                 Style="{StaticResource RatingProgressBarStyle}"
                                                 Progress="{Binding Percentage}" />
                                    <Label Grid.Column="3"
                                           Text="{Binding Count}"
                                           HorizontalTextAlignment="End"
                                           VerticalOptions="Center" />
                                </Grid>
                            </DataTemplate>
                        </BindableLayout.ItemTemplate>
                    </VerticalStackLayout>
                </Grid>
            </Frame>

            <!-- Lista de reseñas -->
            <CollectionView ItemsSource="{Binding Reviews}" SelectionMode="None">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:ServiceReview">
                        <Frame Style="{StaticResource CardFrameStyle}" HasShadow="True" Margin="0,6">
                            <!-- Cambiamos a 4 filas para incluir la línea de barbero/servicio -->
                            <Grid ColumnDefinitions="48,*,Auto"
                                  RowDefinitions="Auto,Auto,Auto,Auto"
                                  ColumnSpacing="12">

                                <!-- Avatar: muestra imagen si hay URL, si no inicial -->
                                <Frame Grid.RowSpan="2"
                                         HeightRequest="40" WidthRequest="40" CornerRadius="20"
                                        BackgroundColor="{DynamicResource SidebarIconBg}"
                                         HasShadow="False" Padding="0" VerticalOptions="Start">
                                    <Grid>
                                        <Image Source="{Binding UserPhotoUrl}"
                                             Aspect="AspectFill"
                                             IsVisible="{Binding UserPhotoUrl, Converter={StaticResource NullToBool}}"
                                                 WidthRequest="40" HeightRequest="40">
                                            <Image.Clip>
                                                <EllipseGeometry Center="20,20" RadiusX="20" RadiusY="20" />
                                            </Image.Clip>
                                        </Image>
                                        <Label Text="{Binding UserName, Converter={StaticResource NameInitialConverter}}"
                                                 IsVisible="{Binding UserPhotoUrl, Converter={StaticResource NullToInverseBool}}"
                                             HorizontalOptions="Center" VerticalOptions="Center"
                                                 FontAttributes="Bold" />
                                    </Grid>
                                </Frame>

                                <Label Grid.Column="1"
                                       Text="{Binding UserName, FallbackValue=Usuario, TargetNullValue=Usuario}"
                                       TextColor="{DynamicResource TextPrimary}"
                                       FontAttributes="Bold" />

                                <Label Grid.Column="2"
                                       Text="{Binding Date, Converter={StaticResource TimeAgoConverter}}"
                                       Style="{StaticResource MutedTextStyle}"
                                       HorizontalTextAlignment="End" />

                                <!-- Estrellas -->
                                <Label Grid.Row="1" Grid.Column="1" Grid.ColumnSpan="2"
                                       Text="{Binding Rating, Converter={StaticResource StarsConverter}}"
                                       TextColor="{DynamicResource Accent}" />

                                <!-- NUEVO: línea barbero / servicio (solo si hay al menos uno) -->
                                <HorizontalStackLayout Grid.Row="2"
                                                       Grid.Column="0"
                                                       Grid.ColumnSpan="3"
                                                       Spacing="6"
                                                       IsVisible="{Binding HasBarberOrService}">
                                    <Label Text="{Binding BarberDisplay}"
                                           Style="{StaticResource MutedTextStyle}"
                                           IsVisible="{Binding BarberDisplay, Converter={StaticResource NullOrWhiteToBoolConverter}}" />
                                    <Label Text="•"
                                           Style="{StaticResource MutedTextStyle}"
                                           IsVisible="{Binding HasBothSelection}" />
                                    <Label Text="{Binding ServiceDisplay}"
                                           Style="{StaticResource MutedTextStyle}"
                                           IsVisible="{Binding ServiceDisplay, Converter={StaticResource NullOrWhiteToBoolConverter}}" />
                                </HorizontalStackLayout>

                                <Label Grid.Row="3" Grid.Column="0" Grid.ColumnSpan="3"
                                       Text="{Binding Comment}"
                                       Style="{StaticResource BodyTextStyle}"
                                       Margin="0,6,0,0" />
                            </Grid>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>