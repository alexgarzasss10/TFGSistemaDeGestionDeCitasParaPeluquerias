<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="SistemasDeGestionCitasPeluqueria.Pages.ReviewDialogPage"
             BackgroundColor="{DynamicResource ModalOverlay}"
             Shell.NavBarIsVisible="False">

    <Grid>
        <Frame Style="{StaticResource CardFrameStyle}"
               HasShadow="True"
               Padding="16"
               Background="{DynamicResource CardBackgroundBrush}"
               HorizontalOptions="Center"
               VerticalOptions="Center"
               MaximumWidthRequest="{OnIdiom Phone=420, Desktop=520, Tablet=480}"
               WidthRequest="{OnIdiom Phone=0, Desktop=520, Tablet=480}">

            <Grid RowDefinitions="Auto,*,Auto">
                <Grid ColumnDefinitions="*,Auto"
                      RowSpacing="0"
                      Padding="0,0,0,4">
                    <Label Text="Escribe tu reseña"
                           Style="{StaticResource SectionTitleStyle}" />
                    <Button Text="✕"
                            BackgroundColor="Transparent"
                            TextColor="{DynamicResource TextSecondary}"
                            Command="{Binding CancelAsyncCommand}"/>
                </Grid>

                <ScrollView Grid.Row="1"
                            VerticalScrollBarVisibility="Always">
                    <VerticalStackLayout Spacing="14"
                                         IsEnabled="{Binding IsPublishing, Converter={StaticResource InverseBoolConverter}}">

                        <Label Text="Comparte tu experiencia con nosotros"
                               Style="{StaticResource MutedTextStyle}" />

                        <!-- Barbero (añadido botón limpiar) -->
                        <VerticalStackLayout>
                            <Label Text="Barbero (opcional)" Style="{StaticResource MutedTextStyle}" />
                            <Border Style="{StaticResource OutlinedPickerBorderStyle}" Padding="8,0" Margin="0,4,0,12">
                                <Grid ColumnDefinitions="*,Auto,Auto" HeightRequest="40">
                                    <Picker x:Name="BarberPicker"
                                            Title="Selecciona un barbero"
                                            Style="{StaticResource ReviewOutlinedPickerStyle}"
                                            ItemsSource="{Binding Barbers}"
                                            ItemDisplayBinding="{Binding Name}"
                                            SelectedItem="{Binding SelectedBarber}">
                                        <Picker.Triggers>
                                            <DataTrigger TargetType="Picker"
                                                         Binding="{Binding SelectedBarber}"
                                                         Value="{x:Null}">
                                                <Setter Property="Title" Value="Selecciona un barbero" />
                                            </DataTrigger>
                                            <DataTrigger TargetType="Picker"
                                                         Binding="{Binding SelectedBarber, Converter={StaticResource IsNotNullConverter}}"
                                                         Value="True">
                                                <Setter Property="Title" Value="" />
                                            </DataTrigger>
                                        </Picker.Triggers>
                                    </Picker>
                                    <Label Style="{StaticResource PickerChevronStyle}" Grid.Column="1" />
                                    <Button Grid.Column="2"
                                            Text="✕"
                                            Padding="0"
                                            WidthRequest="32"
                                            BackgroundColor="Transparent"
                                            TextColor="{DynamicResource TextSecondary}"
                                            Command="{Binding ClearBarberCommand}"
                                            IsVisible="{Binding SelectedBarber, Converter={StaticResource IsNotNullConverter}}"
                                            SemanticProperties.Hint="Quitar barbero seleccionado" />
                                </Grid>
                                <Border.Triggers>
                                    <DataTrigger TargetType="Border"
                                                 Binding="{Binding Source={x:Reference BarberPicker}, Path=IsFocused}"
                                                 Value="True">
                                        <Setter Property="Stroke" Value="{DynamicResource AccentBrush}" />
                                    </DataTrigger>
                                </Border.Triggers>
                            </Border>
                        </VerticalStackLayout>

                        <!-- Servicio (añadido botón limpiar) -->
                        <VerticalStackLayout>
                            <Label Text="Servicio (opcional)" Style="{StaticResource MutedTextStyle}" />
                            <Border Style="{StaticResource OutlinedPickerBorderStyle}" Padding="8,0" Margin="0,4,0,12">
                                <Grid ColumnDefinitions="*,Auto,Auto" HeightRequest="40">
                                    <Picker x:Name="ServicePicker"
                                            Title="Selecciona un servicio"
                                            Style="{StaticResource ReviewOutlinedPickerStyle}"
                                            ItemsSource="{Binding Services}"
                                            ItemDisplayBinding="{Binding Name}"
                                            SelectedItem="{Binding SelectedService}">
                                        <Picker.Triggers>
                                            <DataTrigger TargetType="Picker"
                                                         Binding="{Binding SelectedService}"
                                                         Value="{x:Null}">
                                                <Setter Property="Title" Value="Selecciona un servicio" />
                                            </DataTrigger>
                                            <DataTrigger TargetType="Picker"
                                                         Binding="{Binding SelectedService, Converter={StaticResource IsNotNullConverter}}"
                                                         Value="True">
                                                <Setter Property="Title" Value="" />
                                            </DataTrigger>
                                        </Picker.Triggers>
                                    </Picker>
                                    <Label Style="{StaticResource PickerChevronStyle}" Grid.Column="1" />
                                    <Button Grid.Column="2"
                                            Text="✕"
                                            Padding="0"
                                            WidthRequest="32"
                                            BackgroundColor="Transparent"
                                            TextColor="{DynamicResource TextSecondary}"
                                            Command="{Binding ClearServiceCommand}"
                                            IsVisible="{Binding SelectedService, Converter={StaticResource IsNotNullConverter}}"
                                            SemanticProperties.Hint="Quitar servicio seleccionado" />
                                </Grid>
                                <Border.Triggers>
                                    <DataTrigger TargetType="Border"
                                                 Binding="{Binding Source={x:Reference ServicePicker}, Path=IsFocused}"
                                                 Value="True">
                                        <Setter Property="Stroke" Value="{DynamicResource AccentBrush}" />
                                    </DataTrigger>
                                </Border.Triggers>
                            </Border>
                        </VerticalStackLayout>

                        <VerticalStackLayout>
                            <Label Text="Valoración" Style="{StaticResource MutedTextStyle}" />
                            <HorizontalStackLayout Spacing="8"
                                                   BindableLayout.ItemsSource="{Binding Stars}">
                                <BindableLayout.ItemTemplate>
                                    <DataTemplate>
                                        <Label FontSize="26"
                                               TextColor="{Binding Color}"
                                               Text="{Binding Glyph}">
                                            <Label.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.SetRatingCommand}"
                                                                      CommandParameter="{Binding Value}" />
                                            </Label.GestureRecognizers>
                                        </Label>
                                    </DataTemplate>
                                </BindableLayout.ItemTemplate>
                            </HorizontalStackLayout>
                        </VerticalStackLayout>

                        <VerticalStackLayout>
                            <Label Text="Comentario" Style="{StaticResource MutedTextStyle}" />
                            <Editor AutoSize="TextChanges"
                                    Placeholder="Cuéntanos tu experiencia..."
                                    Text="{Binding Comment}"
                                    TextColor="{DynamicResource TextPrimary}"
                                    PlaceholderColor="{DynamicResource TextSecondary}"
                                    BackgroundColor="Transparent"
                                    HeightRequest="120" />
                        </VerticalStackLayout>

                    </VerticalStackLayout>
                </ScrollView>

                <Grid Grid.Row="2"
                      ColumnDefinitions="*,Auto"
                      Margin="0,12,0,0">
                    <Button Text="Cancelar"
                            Padding="16,10"
                            Style="{StaticResource OutlineButtonStyle}"
                            Command="{Binding CancelAsyncCommand}"
                            IsEnabled="{Binding IsPublishing, Converter={StaticResource InverseBoolConverter}}" />
                    <Button Grid.Column="1"
                            Text="Publicar reseña"
                            Padding="16,10"
                            Style="{StaticResource PrimaryButtonStyle}"
                            Command="{Binding PublishAsyncCommand}"
                            IsEnabled="{Binding CanPublish}" />
                </Grid>

                <ActivityIndicator Grid.RowSpan="3"
                                   HorizontalOptions="Center"
                                   VerticalOptions="Center"
                                   IsRunning="{Binding IsPublishing}"
                                   IsVisible="{Binding IsPublishing}"
                                   Color="{DynamicResource Accent}" />
            </Grid>
        </Frame>
    </Grid>
</ContentPage>