<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:SistemasDeGestionCitasPeluqueria.PageModels"
             xmlns:m="clr-namespace:SistemasDeGestionCitasPeluqueria.Models"
             xmlns:shapes="clr-namespace:Microsoft.Maui.Controls.Shapes;assembly=Microsoft.Maui.Controls"
             x:Class="SistemasDeGestionCitasPeluqueria.Pages.MainPage"
             x:DataType="vm:MainPageModel"
             Title="Inicio"
             BackgroundColor="{DynamicResource Surface}">

    <ScrollView VerticalScrollBarVisibility="Always"
                HorizontalScrollBarVisibility="Never">
        <VerticalStackLayout Padding="16" Spacing="16">

            <Frame Padding="0" HasShadow="True" Style="{StaticResource CardFrameStyle}">
                <Border>
                    <Border.StrokeShape>
                        <shapes:RoundRectangle CornerRadius="12" />
                    </Border.StrokeShape>

                    <!-- Altura del hero aumentada un poco más -->
                    <Grid HeightRequest="{OnIdiom Phone=360, Tablet=460, Desktop=420}">
                        <!-- Hero desde la API (elige mejor resolución en el PageModel) -->
                        <Image Aspect="AspectFill"
                               HorizontalOptions="Fill"
                               VerticalOptions="Fill"
                               Source="{Binding HeroImageUrl, Converter={StaticResource ImageSourceFromStringConverter}}" />
                        <Grid Opacity="0.55" InputTransparent="True">
                            <Grid.Background>
                                <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                                    <GradientStop Color="{DynamicResource HeroOverlayTop}" Offset="0.25" />
                                    <GradientStop Color="{DynamicResource HeroOverlayMid}" Offset="0.55" />
                                    <GradientStop Color="{DynamicResource HeroOverlayBottom}" Offset="1.0" />
                                </LinearGradientBrush>
                            </Grid.Background>
                        </Grid>

                        <VerticalStackLayout Padding="16" Spacing="6" VerticalOptions="End" HorizontalOptions="Start">
                            <Label Text="{Binding BarbershopName}"
                                   TextColor="{StaticResource White}"
                                   FontAttributes="Bold"
                                   FontSize="24"/>
                        </VerticalStackLayout>
                    </Grid>
                </Border>
            </Frame>

            <!-- Tarjetas de información (responsivas, sin colapsar texto y con columnas equilibradas) -->
            <FlexLayout Direction="Row"
                        Wrap="Wrap"
                        AlignItems="Stretch"
                        AlignContent="Stretch"
                        JustifyContent="SpaceBetween">

                <!-- Horario -->
                <Frame Style="{StaticResource CardFrameStyle}"
                       Padding="14"
                       Margin="0,0,0,16"
                       MinimumWidthRequest="260"
                       FlexLayout.Basis="260"
                       FlexLayout.Grow="1"
                       FlexLayout.Shrink="1">
                    <HorizontalStackLayout Spacing="12" VerticalOptions="Center">
                        <Border BackgroundColor="{DynamicResource ServiceIconBgLight}" Padding="10">
                            <Border.StrokeShape>
                                <shapes:RoundRectangle CornerRadius="10" />
                            </Border.StrokeShape>
                            <Label FontFamily="{StaticResource SymbolThemeFontFamily}"
                                   Text="{StaticResource IconGlyph.Schedule}"
                                   FontSize="18"
                                   TextColor="{DynamicResource ServiceIconAccent}" />
                        </Border>
                        <VerticalStackLayout Spacing="4">
                            <Label Text="Horario" Style="{StaticResource InfoCardTitleStyle}" />
                            <Label Style="{StaticResource InfoCardSubTextStyle}" LineBreakMode="WordWrap">
                                <Label.FormattedText>
                                    <FormattedString>
                                        <Span Text="{Binding OpeningLine1Label}" FontAttributes="Bold" />
                                        <Span Text=" " />
                                        <Span Text="{Binding OpeningLine1Value}" />
                                    </FormattedString>
                                </Label.FormattedText>
                            </Label>
                            <Label Style="{StaticResource InfoCardSubTextStyle}" LineBreakMode="WordWrap">
                                <Label.FormattedText>
                                    <FormattedString>
                                        <Span Text="{Binding OpeningLine2Label}" FontAttributes="Bold" />
                                        <Span Text=" " />
                                        <Span Text="{Binding OpeningLine2Value}" />
                                    </FormattedString>
                                </Label.FormattedText>
                            </Label>
                        </VerticalStackLayout>
                    </HorizontalStackLayout>
                </Frame>

                <!-- Ubicación -->
                <Frame Style="{StaticResource CardFrameStyle}"
                       Padding="14"
                       Margin="0,0,0,16"
                       MinimumWidthRequest="260"
                       FlexLayout.Basis="260"
                       FlexLayout.Grow="1"
                       FlexLayout.Shrink="1">
                    <HorizontalStackLayout Spacing="12" VerticalOptions="Center">
                        <Border BackgroundColor="{DynamicResource ServiceIconBgLight}" Padding="10">
                            <Border.StrokeShape>
                                <shapes:RoundRectangle CornerRadius="10" />
                            </Border.StrokeShape>
                            <Label FontFamily="{StaticResource SymbolThemeFontFamily}"
                                   Text="{StaticResource IconGlyph.Location}"
                                   FontSize="18"
                                   TextColor="{DynamicResource ServiceIconAccent}" />
                        </Border>
                        <VerticalStackLayout Spacing="4">
                            <Label Text="Ubicación" Style="{StaticResource InfoCardTitleStyle}" />
                            <Label Text="{Binding AddressText}" Style="{StaticResource InfoCardSubTextStyle}" LineBreakMode="WordWrap" />
                        </VerticalStackLayout>
                    </HorizontalStackLayout>
                </Frame>

                <!-- Contacto -->
                <Frame Style="{StaticResource CardFrameStyle}"
                       Padding="14"
                       Margin="0,0,0,16"
                       MinimumWidthRequest="260"
                       FlexLayout.Basis="260"
                       FlexLayout.Grow="1"
                       FlexLayout.Shrink="1">
                    <HorizontalStackLayout Spacing="12" VerticalOptions="Center">
                        <Border BackgroundColor="{DynamicResource ServiceIconBgLight}" Padding="10">
                            <Border.StrokeShape>
                                <shapes:RoundRectangle CornerRadius="10" />
                            </Border.StrokeShape>
                            <Label FontFamily="{StaticResource SymbolThemeFontFamily}"
                                   Text="{StaticResource IconGlyph.Phone}"
                                   FontSize="18"
                                   TextColor="{DynamicResource ServiceIconAccent}" />
                        </Border>
                        <VerticalStackLayout Spacing="4">
                            <Label Text="Contacto" Style="{StaticResource InfoCardTitleStyle}" />
                            <Label Text="{Binding ContactText}" Style="{StaticResource InfoCardSubTextStyle}" LineBreakMode="WordWrap" />
                        </VerticalStackLayout>
                    </HorizontalStackLayout>
                </Frame>

                <!-- Reservas -->
                <Frame Style="{StaticResource CardFrameStyle}"
                       Padding="14"
                       Margin="0,0,0,16"
                       MinimumWidthRequest="260"
                       FlexLayout.Basis="260"
                       FlexLayout.Grow="1"
                       FlexLayout.Shrink="1">
                    <HorizontalStackLayout Spacing="12" VerticalOptions="Center">
                        <Border BackgroundColor="{DynamicResource ServiceIconBgLight}" Padding="10">
                            <Border.StrokeShape>
                                <shapes:RoundRectangle CornerRadius="10" />
                            </Border.StrokeShape>
                            <Label FontFamily="{StaticResource SymbolThemeFontFamily}"
                                   Text="{StaticResource IconGlyph.Calendar}"
                                   FontSize="18"
                                   TextColor="{DynamicResource ServiceIconAccent}" />
                        </Border>
                        <VerticalStackLayout Spacing="4">
                            <Label Text="Reservas" Style="{StaticResource InfoCardTitleStyle}" />
                            <Label Text="Reserva en línea" Style="{StaticResource InfoCardSubTextStyle}" LineBreakMode="WordWrap" />
                            <Label Text="Fácil y rápido" Style="{StaticResource InfoCardSubTextStyle}" LineBreakMode="WordWrap" />
                        </VerticalStackLayout>
                    </HorizontalStackLayout>
                </Frame>

            </FlexLayout>

            <!-- Nuestros Trabajos -->
            <Label Text="Nuestros Trabajos" Style="{StaticResource SectionTitleStyle}" />

            <!-- FlexLayout responsivo pero sin estirar tarjetas (no pixelan) -->
            <FlexLayout Direction="Row"
                        Wrap="Wrap"
                        AlignItems="Start"
                        JustifyContent="Start"
                        BindableLayout.ItemsSource="{Binding Gallery}">
                <BindableLayout.ItemTemplate>
                    <DataTemplate x:DataType="m:GalleryItem">
                        <Frame Padding="0"
                               HasShadow="True"
                               BackgroundColor="Transparent"
                               CornerRadius="12"
                               IsClippedToBounds="True"
                               WidthRequest="200"
                               FlexLayout.Basis="200"
                               FlexLayout.Grow="0"
                               HeightRequest="240"
                               Margin="0,0,12,12">
                            <Grid>
                                <Image Source="{Binding ImageUrl, Converter={StaticResource ImageSourceFromStringConverter}}"
                                       Aspect="AspectFill"
                                       HorizontalOptions="Fill"
                                       VerticalOptions="Fill" />
                                <BoxView Color="{StaticResource Black}" Opacity="0.22"
                                         HeightRequest="44"
                                         VerticalOptions="End"
                                         HorizontalOptions="Fill" />
                                <Label Text="{Binding Title}"
                                       TextColor="{StaticResource White}"
                                       FontAttributes="Bold"
                                       FontSize="13"
                                       Margin="10,0,10,8"
                                       VerticalOptions="End"
                                       HorizontalOptions="Start" />
                            </Grid>
                        </Frame>
                    </DataTemplate>
                </BindableLayout.ItemTemplate>
            </FlexLayout>

            <!-- Estado de carga -->
            <ActivityIndicator IsRunning="{Binding IsBusy}" IsVisible="{Binding IsBusy}" />

            <!-- Barberos -->
            <Label Text="Barberos" Style="{StaticResource SectionTitleStyle}" />

            <!-- Tarjetas de barbero (más pequeñas) -->
            <FlexLayout Direction="Row"
                        Wrap="Wrap"
                        AlignItems="Start"
                        JustifyContent="Start"
                        BindableLayout.ItemsSource="{Binding Barbers}">
                <BindableLayout.ItemTemplate>
                    <DataTemplate x:DataType="m:Barber">
                        <Frame Padding="0"
                               HasShadow="True"
                               Style="{StaticResource CardFrameStyle}"
                               WidthRequest="200"
                               HeightRequest="260"
                               FlexLayout.Basis="200"
                               FlexLayout.Grow="0"
                               Margin="0,0,12,12">
                            <Grid RowDefinitions="Auto,Auto">
                                <!-- Hero de la tarjeta -->
                                <Border Grid.Row="0">
                                    <Border.StrokeShape>
                                        <shapes:RoundRectangle CornerRadius="12,12,0,0" />
                                    </Border.StrokeShape>
                                    <Grid HeightRequest="190">
                                        <Image Source="{Binding PhotoUrl, Converter={StaticResource ImageSourceFromStringConverter}}"
                                               Aspect="AspectFill"
                                               HorizontalOptions="Fill"
                                               VerticalOptions="Fill" />
                                        <Grid InputTransparent="True" Opacity="0.35">
                                            <Grid.Background>
                                                <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                                                    <GradientStop Color="{DynamicResource HeroOverlayTop}" Offset="0" />
                                                    <GradientStop Color="{StaticResource Black}" Offset="1" />
                                                </LinearGradientBrush>
                                            </Grid.Background>
                                        </Grid>
                                    </Grid>
                                </Border>

                                <!-- Contenido -->
                                <VerticalStackLayout Grid.Row="1"
                                                     Spacing="6"
                                                     Padding="12,8,12,10">
                                    <Label Text="{Binding Name}"
                                           TextColor="{DynamicResource TextPrimary}"
                                           FontAttributes="Bold"
                                           FontSize="16"
                                           LineBreakMode="TailTruncation" />

                                    <!-- Chip de especialidad -->
                                    <Border BackgroundColor="{DynamicResource ServiceIconBgLight}"
                                            Padding="6,3"
                                            StrokeThickness="0"
                                            HorizontalOptions="Start">
                                        <Border.StrokeShape>
                                            <shapes:RoundRectangle CornerRadius="10" />
                                        </Border.StrokeShape>
                                        <HorizontalStackLayout Spacing="6">
                                            <Border WidthRequest="6"
                                                    HeightRequest="6"
                                                    BackgroundColor="{DynamicResource ServiceIconAccent}">
                                                <Border.StrokeShape>
                                                    <shapes:RoundRectangle CornerRadius="3" />
                                                </Border.StrokeShape>
                                            </Border>
                                            <Label Text="{Binding Specialty}"
                                                   FontSize="12"
                                                   TextColor="{DynamicResource TextSecondary}" />
                                        </HorizontalStackLayout>
                                    </Border>

                                    <BoxView HeightRequest="1"
                                             BackgroundColor="{DynamicResource CardBorder}"
                                             Opacity="0.6"
                                             HorizontalOptions="Fill" />

                                    <HorizontalStackLayout Spacing="8" VerticalOptions="Center">
                                        <Label Text="Disponible"
                                               FontSize="12"
                                               TextColor="{DynamicResource Accent}"
                                               FontAttributes="Bold" />
                                        <Label Text="•"
                                               FontSize="12"
                                               TextColor="{DynamicResource TextSecondary}" />
                                        <Label Text="Citas bajo demanda"
                                               FontSize="12"
                                               TextColor="{DynamicResource TextSecondary}" />
                                    </HorizontalStackLayout>
                                </VerticalStackLayout>
                            </Grid>
                        </Frame>
                    </DataTemplate>
                </BindableLayout.ItemTemplate>
            </FlexLayout>

            <!-- Productos destacados -->
            <Label Text="Productos destacados" Style="{StaticResource SectionTitleStyle}" />
            <CollectionView ItemsSource="{Binding FeaturedProducts}" HeightRequest="260">
                <CollectionView.ItemsLayout>
                    <GridItemsLayout Orientation="Vertical" Span="2" />
                </CollectionView.ItemsLayout>
                <CollectionView.EmptyView>
                    <Label Text="No hay productos disponibles." Style="{StaticResource MutedTextStyle}" />
                </CollectionView.EmptyView>
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="m:InventoryItem">
                        <Frame Padding="8" HasShadow="True" Style="{StaticResource CardFrameStyle}">
                            <VerticalStackLayout Spacing="6">
                                <Frame Padding="0"
                                       CornerRadius="12"
                                       HasShadow="False"
                                       IsClippedToBounds="True"
                                       BackgroundColor="{DynamicResource CardBackground}">
                                    <Image Source="{Binding ImageUrl, Converter={StaticResource ImageSourceFromStringConverter}}"
                                           HeightRequest="110"
                                           Aspect="AspectFit"
                                           HorizontalOptions="Center"
                                           VerticalOptions="Center" />
                                </Frame>
                                <Label Text="{Binding Name}"
                                       Style="{StaticResource SectionTitleStyle}"
                                       LineBreakMode="TailTruncation"
                                       MaxLines="2" />
                                <Label Text="{Binding Price, StringFormat='{}{0:C}'}"
                                       TextColor="{DynamicResource Accent}"
                                       FontAttributes="Bold" />
                            </VerticalStackLayout>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <!-- SOBRE NOSOTROS -->
            <Frame Style="{StaticResource CardFrameStyle}"
                   Padding="20"
                   Background="{StaticResource AboutCardBackgroundBrush}">
                <Grid ColumnDefinitions="Auto,*,12,Auto"
                      RowDefinitions="Auto"
                      ColumnSpacing="0">

                    <!-- Barra vertical -->
                    <Border Grid.Column="0"
                            Style="{StaticResource AboutAccentBarStyle}" />

                    <!-- Contenido principal (sin icono) -->
                    <VerticalStackLayout Grid.Column="1"
                                         Spacing="10"
                                         HorizontalOptions="FillAndExpand"> <!-- + rellena la columna -->
                        <Label Text="Sobre Nosotros"
                               Style="{StaticResource SectionTitleStyle}"
                               Margin="0,0,0,4" />

                        <VerticalStackLayout Spacing="8"
                                             HorizontalOptions="FillAndExpand" 
                                             BindableLayout.ItemsSource="{Binding AboutParagraphs}">
                            <BindableLayout.ItemTemplate>
                                <DataTemplate x:DataType="x:String">
                                    <Label Text="{Binding .}"
                                           Style="{StaticResource AboutParagraphStyle}"
                                           HorizontalOptions="FillAndExpand"   
                                           LineBreakMode="WordWrap" />
                                </DataTemplate>
                            </BindableLayout.ItemTemplate>
                        </VerticalStackLayout>
                    </VerticalStackLayout>

                    <!-- Separador -->
                    <BoxView Grid.Column="2"
                             WidthRequest="1"
                             BackgroundColor="{DynamicResource CardBorder}"
                             Opacity="0.6"
                             HorizontalOptions="Center"
                             VerticalOptions="Fill" />

                    <!-- Destacados -->
                    <VerticalStackLayout Grid.Column="3"
                                         Spacing="10"
                                         Padding="16,4,0,4"
                                         BindableLayout.ItemsSource="{Binding AboutHighlights}">
                        <BindableLayout.ItemTemplate>
                            <DataTemplate x:DataType="x:String">
                                <Border Style="{StaticResource AboutHighlightChipStyle}">
                                    <HorizontalStackLayout Spacing="8">
                                        <Border Style="{StaticResource AccentDotStyle}" />
                                        <Label Text="{Binding .}"
                                               TextColor="{DynamicResource TextPrimary}"
                                               FontSize="13" />
                                    </HorizontalStackLayout>
                                </Border>
                            </DataTemplate>
                        </BindableLayout.ItemTemplate>
                    </VerticalStackLayout>
                </Grid>
            </Frame>
        </VerticalStackLayout>
    </ScrollView>
</ContentPage>